<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}EarthScape Agency{% endblock %}</title>

    {% load static %}

    <!-- SEO Meta Tags -->
    <meta name="description"
        content="Advanced climate data monitoring and AI-powered analysis platform for environmental insights.">
    <meta name="keywords" content="climate, weather, AI analysis, environmental monitoring, data analytics">
    <meta name="author" content="EarthScape Climate Agency">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;700&family=Outfit:wght@400;500;700;800&display=swap"
        rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Modern Theme -->
    <link rel="stylesheet" href="{% static 'css/modern_theme.css' %}">

    <!-- HTMX for SPA feel (Optional) -->
    <script src="https://unpkg.com/htmx.org@1.9.2"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    {% block extra_css %}{% endblock %}
</head>
<header class="topbar">
    <div class="topbar-left">
        <button class="topbar-toggle" id="sidebarToggle" aria-label="Toggle sidebar">
            <i class="fas fa-bars"></i>
        </button>

        <div class="topbar-search">
            <i class="fas fa-search topbar-search-icon"></i>
            <input type="text" placeholder="Search climate data, sources, reports..." aria-label="Search">
        </div>
    </div>

    <div class="topbar-right">
        <!-- Theme Toggle -->
        <button class="topbar-action" id="themeToggle" aria-label="Toggle dark mode">
            <i class="fas fa-moon"></i>
        </button>

        <!-- User Menu -->
        <div class="user-menu" onclick="toggleUserDropdown()">
            <div class="user-avatar">
                {{ user.username|slice:":1"|upper }}
            </div>
            <div class="user-info">
                <div class="user-name">{{ user.get_full_name|default:user.username }}</div>
                <div class="user-role">{{ user.get_role_display }}</div>
            </div>
            <i class="fas fa-chevron-down" style="color: var(--color-text-tertiary); font-size: 0.75rem;"></i>
        </div>
    </div>
</header>

<!-- Page Content -->
<main class="content-wrapper animate-fade-in">
    <!-- Flash Messages -->
    {% if messages %}
    <div class="messages-wrapper" style="margin-bottom: var(--spacing-xl);">
        {% for message in messages %}
        <div class="toast toast-{{ message.tags }} animate-slide-in-right"
            style="position: relative; margin-bottom: var(--spacing-md);">
            <div class="toast-icon">
                {% if message.tags == 'success' %}
                <i class="fas fa-check-circle"></i>
                {% elif message.tags == 'error' or message.tags == 'danger' %}
                <i class="fas fa-exclamation-circle"></i>
                {% elif message.tags == 'warning' %}
                <i class="fas fa-exclamation-triangle"></i>
                {% else %}
                <i class="fas fa-info-circle"></i>
                {% endif %}
            </div>
            <div class="toast-content">
                <div class="toast-title">
                    {% if message.tags == 'success' %}Success
                    {% elif message.tags == 'error' or message.tags == 'danger' %}Error
                    {% elif message.tags == 'warning' %}Warning
                    {% else %}Information{% endif %}
                </div>
                <div class="toast-message">{{ message }}</div>
            </div>
            <button class="toast-close" onclick="this.parentElement.remove()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Content Block -->
    {% block page_content %}{% endblock %}
</main>
</div>
</div>
{% endif %}

<!-- JavaScript Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

<!-- Custom JavaScript -->
<script>
    // Sidebar Toggle
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    const sidebarToggle = document.getElementById('sidebarToggle');

    if (sidebarToggle) {
        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded');
            localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
        });

        // Restore sidebar state
        const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
        if (sidebarCollapsed) {
            sidebar.classList.add('collapsed');
            mainContent.classList.add('expanded');
        }
    }

    // Theme Toggle
    const themeToggle = document.getElementById('themeToggle');
    const htmlElement = document.documentElement;

    if (themeToggle) {
        themeToggle.addEventListener('click', () => {
            const currentTheme = document.body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);

            // Update icon
            const icon = themeToggle.querySelector('i');
            icon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        });

        // Restore theme
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.body.setAttribute('data-theme', savedTheme);
        const icon = themeToggle.querySelector('i');
        if (icon) {
            icon.className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }
    }

    // User Dropdown (placeholder)
    function toggleUserDropdown() {
        window.location.href = '{% url "authentication:profile" %}';
    }

    // Toast Notification System
    function showToast(type, title, message, duration = 5000) {
        const container = document.getElementById('toastContainer');

        const icons = {
            success: 'fa-check-circle',
            error: 'fa-exclamation-circle',
            warning: 'fa-exclamation-triangle',
            info: 'fa-info-circle'
        };

        const toast = document.createElement('div');
        toast.className = `toast toast-${type} animate-slide-in-right`;
        toast.innerHTML = `
                <div class="toast-icon">
                    <i class="fas ${icons[type] || icons.info}"></i>
                </div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;

        container.appendChild(toast);

        // Auto remove after duration
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(100%)';
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }

    // Auto-dismiss flash messages
    setTimeout(() => {
        const messages = document.querySelectorAll('.messages-wrapper .toast');
        messages.forEach(msg => {
            msg.style.opacity = '0';
            msg.style.transform = 'translateX(100%)';
            setTimeout(() => msg.remove(), 300);
        });
    }, 5000);

    // Form Submit Loading States
    document.addEventListener('DOMContentLoaded', () => {
        const forms = document.querySelectorAll('form');
        forms.forEach(form => {
            form.addEventListener('submit', function (e) {
                const submitBtn = this.querySelector('button[type="submit"]');
                if (submitBtn && !submitBtn.disabled) {
                    submitBtn.disabled = true;
                    const originalContent = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

                    // Re-enable after 10 seconds as fallback
                    setTimeout(() => {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalContent;
                    }, 10000);
                }
            });
        });
    });

    // Responsive Sidebar for Mobile
    if (window.innerWidth <= 1024) {
        if (sidebar) sidebar.classList.add('collapsed');
        if (mainContent) mainContent.classList.add('expanded');

        // Toggle on mobile
        if (sidebarToggle) {
            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('open');
            });
        }

        // Close sidebar when clicking outside
        document.addEventListener('click', (e) => {
            if (sidebar && !sidebar.contains(e.target) && e.target !== sidebarToggle) {
                sidebar.classList.remove('open');
            }
        });
    }
</script>

{% block extra_scripts %}{% endblock %}
</body>

</html>